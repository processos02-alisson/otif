<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel OTIF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs (Compat para simplicidade) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
  <style>
    .card{transition:transform .15s ease,box-shadow .15s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .chip{font-size:.75rem;padding:.25rem .5rem;border-radius:9999px;background:#f1f5f9;color:#475569}
    .modal-bg{background:rgba(0,0,0,.45)}
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-weight:600}
    .tbl th,.tbl td{padding:.5rem .5rem;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    .cell-edit[contenteditable="true"]{background:#fffbe6;outline:none}
    .icon-btn{font-size:.9rem;padding:.25rem .5rem;border-radius:.375rem}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- LOGIN -->
  <section id="login-screen" class="min-h-screen grid place-items-center">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-extrabold">Painel <span class="text-blue-600">OTIF</span></h1>
        <p class="text-sm text-slate-500 mt-1">Acesse com seu usu√°rio e senha</p>
      </div>
      <div class="space-y-3">
        <input id="user" class="w-full rounded-lg border p-3" placeholder="Usu√°rio (master ou visual)"/>
        <input id="pass" type="password" class="w-full rounded-lg border p-3" placeholder="Senha (123)"/>
        <button onclick="login()" class="w-full rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3">Entrar</button>
      </div>
      <div class="text-xs text-slate-400 mt-4">
        Demos: <b>master/123</b> (admin) ‚Ä¢ <b>visual/123</b> (somente leitura)
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
      <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold tracking-tight">üìä Painel OTIF</h2>
          <p class="text-sm text-blue-100">Visual ao vivo para toda a empresa</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="userName" class="text-sm bg-white/15 px-3 py-1 rounded-full"></span>
          <button onclick="logout()" class="text-sm font-semibold bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">Sair</button>
        </div>
      </div>
      <!-- Banner de Meta -->
      <div id="metaBanner" class="hidden text-center py-2 font-semibold"></div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">
      <!-- Filtros -->
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex flex-wrap items-center gap-3">
          <span class="font-semibold">Per√≠odo:</span>
          <input id="startDate" type="date" class="border rounded-lg p-2">
          <input id="endDate" type="date" class="border rounded-lg p-2">
          <button onclick="filtrarDados()" class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 font-semibold">Aplicar</button>
          <div class="ml-auto flex gap-2">
            <button onclick="presetDia()"    class="chip">Hoje</button>
            <button onclick="presetSemana()" class="chip">Semana</button>
            <button onclick="presetMes()"    class="chip">M√™s</button>
          </div>
        </div>
      </div>

      <!-- Configura√ß√µes de Visibilidade (Master) -->
      <div id="visPanel" class="hidden bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Configura√ß√µes de Visibilidade (para perfil Visual)</h3>
          <button id="visSaveBtn" class="px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold">Salvar</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
          <label class="flex items-center gap-2"><input id="visPie"    type="checkbox" class="scale-110"> Motivos (Pizza)</label>
          <label class="flex items-center gap-2"><input id="visPareto" type="checkbox" class="scale-110"> Pareto (Setores)</label>
          <label class="flex items-center gap-2"><input id="visLinha"  type="checkbox" class="scale-110"> Evolu√ß√£o (Linha)</label>
          <label class="flex items-center gap-2"><input id="visTabela" type="checkbox" class="scale-110"> Tabela de Atrasos</label>
        </div>
        <p class="text-xs text-slate-500 mt-2">Essas op√ß√µes n√£o afetam o Master. O Visual ver√° apenas o que estiver habilitado.</p>
      </div>

      <!-- Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
        <div class="card bg-white rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-slate-500">Total de Pedidos</span><span class="text-slate-400">Œ£</span>
          </div>
          <div class="mt-2 text-2xl font-bold" id="totalPedidos">0</div>
        </div>

        <div id="cardPrazo" class="card bg-emerald-50 rounded-2xl shadow p-4 cursor-pointer" title="Duplo clique para listar/editar (master)">
          <div class="flex justify-between">
            <span class="text-emerald-700">No Prazo</span><span>‚úÖ</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-emerald-800" id="entreguesPrazo">0</div>
          <p class="text-xs text-emerald-700/70 mt-1">Duplo clique para planilha</p>
        </div>

        <div id="cardFora" class="card bg-rose-50 rounded-2xl shadow p-4 cursor-pointer" title="Duplo clique para listar/editar (master)">
          <div class="flex justify-between">
            <span class="text-rose-700">Fora do Prazo</span><span>‚õî</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-rose-800" id="foraPrazo">0</div>
          <p class="text-xs text-rose-700/70 mt-1">Duplo clique para planilha</p>
        </div>

        <div class="card bg-amber-50 rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-amber-700">N/C</span><span>‚ùî</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-amber-800" id="naoClassificados">0</div>
        </div>

        <div class="card bg-blue-50 rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-blue-700">OTIF (%)</span><span>üìà</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-blue-800" id="otifPercent">0%</div>
        </div>

        <div class="card bg-slate-100 rounded-2xl shadow p-4">
          <div class="flex justify-between items-center">
            <span class="text-slate-700">Meta (%)</span>
            <button id="btnEditMeta" class="hidden text-xs bg-white px-2 py-1 rounded border">‚úèÔ∏è Editar</button>
          </div>
          <div class="mt-2 text-2xl font-bold flex items-center gap-3">
            <span id="metaPercent">80%</span>
            <input id="metaInput" type="number" min="0" max="100" step="0.01" class="hidden border rounded px-2 py-1 w-24"/>
            <button id="btnSaveMeta" class="hidden text-xs bg-emerald-600 text-white px-2 py-1 rounded">Salvar</button>
            <button id="btnCancelMeta" class="hidden text-xs bg-slate-300 text-slate-800 px-2 py-1 rounded">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- A√ß√µes do Master -->
      <div id="blocoMaster" class="hidden bg-white rounded-2xl shadow p-4 flex flex-wrap items-center gap-3">
        <span class="font-semibold">Admin:</span>
        <input id="csvInput" type="file" accept=".csv" class="hidden"/>
        <button onclick="document.getElementById('csvInput').click()" class="btn bg-emerald-600 hover:bg-emerald-700 text-white">
          Importar CSV (Fora Prazo)
        </button>
        <button onclick="baixarTemplate()" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800">
          Baixar Template CSV
        </button>
        <span class="text-xs text-slate-500">Aceita v√≠rgula ou ponto-e-v√≠rgula ‚Ä¢ Datas DD/MM/AAAA ou AAAA-MM-DD</span>
      </div>

      <!-- Gr√°ficos (GRID DIN√ÇMICO) -->
      <div id="graficoGrid" class="grid gap-6 transition-all duration-300">
        <div id="sectionPie" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Motivos de Atraso</h3>
          <canvas id="graficoPizza"></canvas>
        </div>
        <div id="sectionPareto" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Pareto ‚Äì Setores</h3>
          <canvas id="graficoPareto"></canvas>
        </div>
        <div id="sectionLinha" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Evolu√ß√£o (atrasos por dia)</h3>
          <canvas id="graficoLinha"></canvas>
        </div>
      </div>

      <!-- Tabela de atrasos -->
      <div id="sectionTabela" class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Pedidos em Atraso</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 text-left">
              <tr>
                <th class="p-2">Cliente</th>
                <th class="p-2">Pedido</th>
                <th class="p-2">Produto</th>
                <th class="p-2">Motivo</th>
                <th class="p-2">Setor</th>
                <th class="p-2">DataEntrega</th>
              </tr>
            </thead>
            <tbody id="tabelaDados" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </main>
  </section>

  <!-- MODAL: planilhazinha (No Prazo / Fora do Prazo) -->
  <div id="modalList" class="hidden fixed inset-0 modal-bg z-40">
    <div class="min-h-full grid place-items-center px-4">
      <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalListTitle" class="text-xl font-semibold">Listagem</h2>
          <div class="flex items-center gap-2">
            <button id="btnAddRow" class="hidden icon-btn bg-emerald-600 text-white">+ Linha</button>
            <button id="btnSaveSheet" class="hidden icon-btn bg-blue-600 text-white">Salvar</button>
            <button onclick="fecharModalList()" class="icon-btn bg-slate-200 text-slate-800">Fechar</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm tbl">
            <thead id="modalHead" class="bg-slate-100 text-left"></thead>
            <tbody id="modalBody" class="bg-white"></tbody>
          </table>
        </div>
        <p id="modalHint" class="text-xs text-slate-500 mt-3"></p>
      </div>
    </div>
  </div>

<script>
/* =============== Firebase Init =============== */
const firebaseConfig = {
  apiKey: "AIzaSyBbo6DNAzPFqUgfu_zDjw7f_711L3UfHfY",
  authDomain: "painel-otif.firebaseapp.com",
  projectId: "painel-otif",
  storageBucket: "painel-otif.firebasestorage.app",
  messagingSenderId: "1059621768811",
  appId: "1:1059621768811:web:b8c70235f3c17490bbab2e",
  measurementId: "G-2WF5J8CCM8",
  // databaseURL √© necess√°rio para Realtime DB (se n√£o estiver setado no console, adicione aqui)
  databaseURL: "https://painel-otif-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =============== AUTH DE PERFIL (LOCAL) =============== */
/* Apenas para definir permiss√µes de UI (master vs visual) */
const usuarios = { master:{senha:"123",role:"master"}, visual:{senha:"123",role:"visual"} };
let usuarioAtual = null;

/* =============== Refer√™ncias do DB =============== */
const REF_FORA   = db.ref("otif/foraPrazo");              // Array de objetos
const REF_PRAZO  = db.ref("otif/noPrazo");                // Array de objetos
const REF_META   = db.ref("otif/meta/globalPercent");     // Number
const REF_VIS    = db.ref("otif/config/visibilityForViewer"); // {pie,pareto,linha,tabela}

/* =============== Estado local =============== */
let atrasos = [];   // Fora Prazo
let noPrazo = [];   // No Prazo
let metaValue = 80; // Meta %
let visConfig = { pie:true, pareto:true, linha:true, tabela:true };

let chartPizza=null, chartPareto=null, chartLinha=null;

/* =============== Login / Logout =============== */
function login(){
  const u=qs("#user").value.trim(), p=qs("#pass").value.trim();
  if(usuarios[u] && usuarios[u].senha===p){
    usuarioAtual={nome:u, role:usuarios[u].role};
    qs("#login-screen").classList.add("hidden");
    qs("#dashboard").classList.remove("hidden");
    qs("#userName").textContent=`Usu√°rio: ${u} (${usuarioAtual.role})`;

    const isMaster = usuarioAtual.role==="master";
    qs("#btnEditMeta").classList.toggle("hidden", !isMaster);
    qs("#blocoMaster").classList.toggle("hidden", !isMaster);
    qs("#visPanel").classList.toggle("hidden", !isMaster);

    // Dblclick nos cards para abrir planilhas
    qs("#cardPrazo").ondblclick = ()=> abrirPlanilha("prazo");
    qs("#cardFora").ondblclick  = ()=> abrirPlanilha("fora");

    // Carrega visibilidade para preencher checkboxes
    id("visPie").checked    = !!visConfig.pie;
    id("visPareto").checked = !!visConfig.pareto;
    id("visLinha").checked  = !!visConfig.linha;
    id("visTabela").checked = !!visConfig.tabela;

    renderizarTudo();
  } else {
    alert("Usu√°rio ou senha incorretos!");
  }
}
function logout(){
  usuarioAtual=null;
  qs("#dashboard").classList.add("hidden");
  qs("#login-screen").classList.remove("hidden");
}

/* =============== Subscri√ß√µes Realtime =============== */
REF_FORA.on("value", snap=>{
  atrasos = snap.val() || [];
  renderizarTudo();
});
REF_PRAZO.on("value", snap=>{
  noPrazo = snap.val() || [];
  renderizarTudo();
});
REF_META.on("value", snap=>{
  const v = parseFloat(snap.val());
  if(!isNaN(v)) metaValue = v;
  renderizarTudo();
});
REF_VIS.on("value", snap=>{
  const v = snap.val();
  if(v) visConfig = { pie:!!v.pie, pareto:!!v.pareto, linha:!!v.linha, tabela:!!v.tabela };
  // Atualiza checkboxes se master j√° logado
  if(usuarioAtual?.role === "master"){
    id("visPie").checked    = visConfig.pie;
    id("visPareto").checked = visConfig.pareto;
    id("visLinha").checked  = visConfig.linha;
    id("visTabela").checked = visConfig.tabela;
  }
  applyVisibilityForViewer();
  ajustarGridGraficos();
});

/* =============== Filtros =============== */
function filtrarDados(){ renderizarTudo(); }
function presetDia(){ const d=isoToday(); setDates(d,d); renderizarTudo(); }
function presetSemana(){
  const now=new Date(), day=now.getDay()||7;
  const mon=new Date(now); mon.setDate(now.getDate()-day+1);
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  setDates(toISO(mon), toISO(sun)); renderizarTudo();
}
function presetMes(){
  const now=new Date(); const first=new Date(now.getFullYear(),now.getMonth(),1); const last=new Date(now.getFullYear(),now.getMonth()+1,0);
  setDates(toISO(first), toISO(last)); renderizarTudo();
}
function setDates(s,e){ id("startDate").value=s; id("endDate").value=e; }
function aplicaPeriodo(lista){
  const s=id("startDate").value, e=id("endDate").value;
  if(!s||!e) return [...lista];
  return lista.filter(r => (r.dataEntrega||"")>=s && (r.dataEntrega||"")<=e);
}

/* =============== Render Principal =============== */
function renderizarTudo(){
  const atrasosF=aplicaPeriodo(atrasos), prazoF=aplicaPeriodo(noPrazo);
  const total=atrasosF.length+prazoF.length, fora=atrasosF.length, ok=prazoF.length, nc=0;
  const otif = total>0 ? ((ok/total)*100) : 0;

  txt("totalPedidos", total);
  txt("entreguesPrazo", ok);
  txt("foraPrazo", fora);
  txt("naoClassificados", nc);
  txt("otifPercent", `${otif.toFixed(2)}%`);
  txt("metaPercent", `${metaValue.toFixed(2)}%`);

  atualizarStatusMeta(otif, metaValue);

  const tbody=id("tabelaDados"); tbody.innerHTML="";
  atrasosF.forEach(a=>{
    tbody.insertAdjacentHTML("beforeend", `
      <tr class="hover:bg-slate-50">
        <td class="p-2">${a.cliente||""}</td>
        <td class="p-2">${a.pedido||""}</td>
        <td class="p-2">${a.produto||""}</td>
        <td class="p-2">${a.motivo||""}</td>
        <td class="p-2">${a.setor||""}</td>
        <td class="p-2">${a.dataEntrega||""}</td>
      </tr>
    `);
  });

  renderGraficos(atrasosF);
  applyVisibilityForViewer();
  ajustarGridGraficos();
}

/* =============== Gr√°ficos =============== */
function renderGraficos(data){
  if(chartPizza) chartPizza.destroy();
  if(chartPareto) chartPareto.destroy();
  if(chartLinha) chartLinha.destroy();

  const motivos=countBy(data, d=> (d.motivo||"Sem motivo"));
  chartPizza=new Chart(id("graficoPizza"),{type:"pie",data:{labels:Object.keys(motivos),datasets:[{data:Object.values(motivos)}]}});

  const setoresMap=countBy(data, d=> (d.setor||"Sem setor"));
  const setoresOrd=Object.entries(setoresMap).sort((a,b)=>b[1]-a[1]);
  chartPareto=new Chart(id("graficoPareto"),{
    type:"bar",
    data:{labels:setoresOrd.map(x=>x[0]),datasets:[{label:"Atrasos",data:setoresOrd.map(x=>x[1])}]},
    options:{plugins:{legend:{display:false}}}
  });

  const porData=countBy(data, d=> d.dataEntrega||"");
  const datasOrd=Object.keys(porData).sort();
  chartLinha=new Chart(id("graficoLinha"),{
    type:"line",
    data:{labels:datasOrd,datasets:[{label:"Atrasos",data:datasOrd.map(k=>porData[k])}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}
function countBy(arr, fn){ const m={}; arr.forEach(x=>{const k=fn(x); m[k]=(m[k]||0)+1;}); return m; }

/* =============== Grid Din√¢mico dos Gr√°ficos =============== */
function ajustarGridGraficos(){
  const grid = document.getElementById("graficoGrid");
  if(!grid) return;
  const visiveis = ["#sectionPie","#sectionPareto","#sectionLinha"]
    .map(sel => document.querySelector(sel))
    .filter(el => el && el.style.display !== "none");
  const count = visiveis.length;
  let colsClass = "grid-cols-1 md:grid-cols-3";
  if (count === 1) colsClass = "grid-cols-1";
  if (count === 2) colsClass = "grid-cols-1 md:grid-cols-2";
  if (count === 3) colsClass = "grid-cols-1 md:grid-cols-3";
  grid.className = `grid gap-6 transition-all duration-300 ${colsClass}`;
  visiveis.forEach(v => v.classList.add("h-full"));
}

/* =============== Planilhas (Edit√°vel p/ Master) =============== */
let modalTipo="fora"; // "fora" | "prazo"
function abrirPlanilha(tipo){
  modalTipo=tipo;
  const isMaster = usuarioAtual?.role==="master";
  const title= tipo==="fora" ? "Fora do Prazo ‚Äî editar/alimentar" : "No Prazo ‚Äî editar/alimentar";
  txt("modalListTitle", title);

  id("btnAddRow").classList.toggle("hidden", !isMaster);
  id("btnSaveSheet").classList.toggle("hidden", !isMaster);

  const head = (tipo==="fora")
    ? ["Cliente","Pedido","Produto","Quantidade","Motivo/Obs","Setor","DataCliente","DataEntrega",""]
    : ["Cliente","Pedido","Produto","Quantidade","DataCliente","DataEntrega",""];
  id("modalHead").innerHTML = `<tr>${head.map(h=>`<th class="p-2">${h}</th>`).join("")}</tr>`;

  const data = (tipo==="fora") ? aplicaPeriodo(atrasos) : aplicaPeriodo(noPrazo);
  const editable = isMaster;
  const body=id("modalBody"); body.innerHTML="";
  data.forEach((r, idx)=> body.insertAdjacentHTML("beforeend", linhaModalHTML(r, idx, tipo, editable)));

  txt("modalHint", isMaster ? "Clique nas c√©lulas para editar. '+ Linha' adiciona. 'Salvar' confirma as mudan√ßas." : "Visualiza√ß√£o somente leitura.");
  id("modalList").classList.remove("hidden");
}
function linhaModalHTML(r, idx, tipo, editable){
  const ce=(v,f)=>`<td class="cell-edit" contenteditable="${editable}" data-field="${f}">${v??""}</td>`;
  const delBtn = usuarioAtual?.role==="master"
    ? `<button class="icon-btn bg-rose-100 text-rose-700" onclick="excluirLinha(${idx})">Excluir</button>` : "";
  if(tipo==="fora"){
    return `<tr>
      ${ce(r.cliente,"cliente")}
      ${ce(r.pedido,"pedido")}
      ${ce(r.produto,"produto")}
      ${ce(r.quantidade,"quantidade")}
      ${ce(r.motivo,"motivo")}
      ${ce(r.setor,"setor")}
      ${ce(r.dataCliente,"dataCliente")}
      ${ce(r.dataEntrega,"dataEntrega")}
      <td>${delBtn}</td>
    </tr>`;
  } else {
    return `<tr>
      ${ce(r.cliente,"cliente")}
      ${ce(r.pedido,"pedido")}
      ${ce(r.produto,"produto")}
      ${ce(r.quantidade,"quantidade")}
      ${ce(r.dataCliente,"dataCliente")}
      ${ce(r.dataEntrega,"dataEntrega")}
      <td>${delBtn}</td>
    </tr>`;
  }
}
function fecharModalList(){ id("modalList").classList.add("hidden"); }

id("btnAddRow").addEventListener("click",async ()=>{
  if(usuarioAtual?.role!=="master") return;
  const novo = (modalTipo==="fora")
    ? {cliente:"",pedido:"",produto:"",quantidade:"",motivo:"",setor:"",dataCliente:"",dataEntrega:""}
    : {cliente:"",pedido:"",produto:"",quantidade:"",dataCliente:"",dataEntrega:""};
  if(modalTipo==="fora"){ atrasos.push(novo); await REF_FORA.set(atrasos); }
  else { noPrazo.push(novo); await REF_PRAZO.set(noPrazo); }
  abrirPlanilha(modalTipo);
});
id("btnSaveSheet").addEventListener("click",async ()=>{
  if(usuarioAtual?.role!=="master") return;
  const rows=[...document.querySelectorAll("#modalBody tr")];
  const dados = rows.map(tr=>{
    const obj={};
    tr.querySelectorAll("td[data-field]").forEach(td=>{
      const k=td.getAttribute("data-field"); let v=td.textContent.trim();
      if(k==="dataCliente"||k==="dataEntrega") v=normalizeDateToISO(v);
      obj[k]=v;
    });
    return obj;
  }).filter(o=> (o.cliente||"") && (o.pedido||"") && (o.dataEntrega||""));

  if(modalTipo==="fora"){ atrasos=dados; await REF_FORA.set(atrasos); }
  else { noPrazo=dados; await REF_PRAZO.set(noPrazo); }

  alert("Planilha salva com sucesso.");
  renderizarTudo();
  abrirPlanilha(modalTipo);
});
async function excluirLinha(idxView){
  if(usuarioAtual?.role!=="master") return;
  const baseF = (modalTipo==="fora") ? aplicaPeriodo(atrasos) : aplicaPeriodo(noPrazo);
  const alvo = baseF[idxView]; if(!alvo) return;
  const base = (modalTipo==="fora") ? atrasos : noPrazo;
  const i = base.findIndex(x=> JSON.stringify(x)===JSON.stringify(alvo));
  if(i>=0) base.splice(i,1);
  if(modalTipo==="fora") await REF_FORA.set(atrasos); else await REF_PRAZO.set(noPrazo);
  abrirPlanilha(modalTipo); renderizarTudo();
}

/* =============== Meta & Banner (üëç/üëé) =============== */
function atualizarStatusMeta(otif, meta){
  const banner=id("metaBanner");
  if(otif>=meta){
    banner.textContent = `üëç META ALCAN√áADA ‚Äî ${otif.toFixed(2)}% ‚â• ${meta.toFixed(2)}%`;
    banner.className   = "text-center py-2 font-semibold bg-green-100 text-green-700 border-b-2 border-green-400";
  }else{
    banner.textContent = `üëé META N√ÉO ATINGIDA ‚Äî ${otif.toFixed(2)}% < ${meta.toFixed(2)}%`;
    banner.className   = "text-center py-2 font-semibold bg-red-100 text-red-700 border-b-2 border-red-400";
  }
  banner.classList.remove("hidden");
}
function atualizarMetaUI(editing){
  const isMaster = usuarioAtual?.role==="master";
  id("btnEditMeta").classList.toggle("hidden", !isMaster || editing);
  id("metaInput").classList.toggle("hidden", !editing);
  id("btnSaveMeta").classList.toggle("hidden", !editing);
  id("btnCancelMeta").classList.toggle("hidden", !editing);
  id("metaPercent").classList.toggle("hidden", editing);
  if(editing) id("metaInput").value = metaValue.toFixed(2);
}
id("btnEditMeta").addEventListener("click",()=> atualizarMetaUI(true));
id("btnCancelMeta").addEventListener("click",()=> atualizarMetaUI(false));
id("btnSaveMeta").addEventListener("click",async ()=>{
  const v=parseFloat(id("metaInput").value);
  if(isNaN(v)||v<0||v>100){ alert("Informe um valor de 0 a 100."); return; }
  metaValue=v;
  await REF_META.set(metaValue);
  atualizarMetaUI(false); renderizarTudo();
});

/* =============== Visibilidade para Visual (salva no DB) =============== */
function applyVisibilityForViewer(){
  if(usuarioAtual?.role!=="visual"){
    show("#sectionPie", true); show("#sectionPareto", true); show("#sectionLinha", true); show("#sectionTabela", true);
    return;
  }
  const vis=visConfig;
  show("#sectionPie", !!vis.pie);
  show("#sectionPareto", !!vis.pareto);
  show("#sectionLinha", !!vis.linha);
  show("#sectionTabela", !!vis.tabela);

  if(!vis.pie && chartPizza){ chartPizza.destroy(); chartPizza=null; }
  if(!vis.pareto && chartPareto){ chartPareto.destroy(); chartPareto=null; }
  if(!vis.linha && chartLinha){ chartLinha.destroy(); chartLinha=null; }
}
id("visSaveBtn").addEventListener("click", async ()=>{
  if(usuarioAtual?.role!=="master") return;
  const v={ pie:id("visPie").checked, pareto:id("visPareto").checked, linha:id("visLinha").checked, tabela:id("visTabela").checked };
  await REF_VIS.set(v);
  alert("Prefer√™ncias salvas (aplicam ao perfil Visual).");
  ajustarGridGraficos();
});

/* =============== Importa√ß√£o CSV (Fora Prazo) =============== */
id("csvInput").addEventListener("change", async ev=>{
  if(usuarioAtual?.role!=="master"){ ev.target.value=""; return; }
  const file=ev.target.files?.[0]; if(!file) return;
  try{
    const text=await file.text(); const rows=parseCSV(text);
    if(rows.length<2){ alert("CSV sem dados."); return; }
    const header=rows[0].map(normalizeHeader);
    const idx={
      cliente:header.indexOf("cliente"),
      pedido:header.indexOf("pedido"),
      produto:header.indexOf("produto"),
      quantidade:header.indexOf("quantidade"),
      motivo:(()=>{const i1=header.indexOf("motivo"), i2=header.indexOf("motivoobs"); return i1>=0?i1:(i2>=0?i2:-1);})(),
      setor:header.indexOf("setor"),
      datacliente:header.indexOf("datacliente"),
      dataentrega:header.indexOf("dataentrega")
    };
    if([idx.cliente,idx.pedido,idx.produto,idx.quantidade,idx.setor,idx.dataentrega].some(v=>v===-1)){
      alert("Cabe√ßalho esperado (case-insensitive): cliente,pedido,produto,quantidade,motivo/obs,setor,datacliente,dataentrega");
      return;
    }
    let ins=0,pul=0;
    const novos=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r||!r.length) continue;
      const obj={
        cliente:(r[idx.cliente]??"").trim(),
        pedido:(r[idx.pedido]??"").trim(),
        produto:(r[idx.produto]??"").trim(),
        quantidade:(r[idx.quantidade]??"").trim(),
        motivo: idx.motivo>=0 ? (r[idx.motivo]??"").trim() : "",
        setor:(r[idx.setor]??"").trim(),
        dataCliente: normalizeDateToISO((r[idx.datacliente]??"").trim()),
        dataEntrega: normalizeDateToISO((r[idx.dataentrega]??"").trim())
      };
      if(!obj.cliente||!obj.pedido||!obj.dataEntrega){ pul++; continue; }
      novos.push(obj); ins++;
    }
    // Mescla com os atuais (se quiser, d√° pra de-duplicar por chave)
    atrasos = atrasos.concat(novos);
    await REF_FORA.set(atrasos);
    ev.target.value="";
    alert(`Importa√ß√£o conclu√≠da.\nInseridos: ${ins}\nPulados: ${pul}`);
    renderizarTudo();
  }catch(e){ console.error(e); alert("Falha ao ler o CSV."); ev.target.value=""; }
});
function baixarTemplate(){
  const content="cliente,pedido,produto,quantidade,motivo,setor,datacliente,dataentrega\nZION SIGNAL,10311/1,81100010,10,Mat√©ria-prima solicitada diferente,MegaWhip,2025-09-29,2025-10-01\n";
  const blob=new Blob([content],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="otif_foraprazo_template.csv"; a.click(); URL.revokeObjectURL(url);
}
function parseCSV(text){
  const hasSemicolon=text.indexOf(";")!==-1; const delim=hasSemicolon?";":",";
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
  return lines.map(line=>splitCSVLine(line,delim));
}
function splitCSVLine(line,delim){
  const out=[]; let cur="",q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"';i++;} else q=!q; }
    else if(ch===delim && !q){ out.push(cur.trim()); cur=""; }
    else cur+=ch;
  }
  out.push(cur.trim()); return out;
}
function normalizeHeader(h){
  return (h||"").toString().trim().toLowerCase()
    .replace(/\s+/g,"").replace(/√ß/g,"c")
    .replace(/[√°√†√¢√£]/g,"a").replace(/[√©√®√™]/g,"e").replace(/[√≠√¨√Æ]/g,"i")
    .replace(/[√≥√≤√¥√µ]/g,"o").replace(/[√∫√π√ª]/g,"u").replace(/\//g,"");
}

/* =============== Helpers =============== */
function qs(s){return document.querySelector(s)}; function id(s){return document.getElementById(s)}
function txt(el,val){ id(el).textContent=val }
function show(sel,flag){ const el=qs(sel); if(el) el.style.display = flag ? "" : "none"; }
function isoToday(){ return new Date().toISOString().slice(0,10); }
function toISO(d){ const z=new Date(d); return z.toISOString().slice(0,10); }
function normalizeDateToISO(v){
  v=(v||"").trim();
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){ const [d,m,a]=v.split("/"); return `${a}-${m}-${d}`; }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const dt=new Date(v); if(!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
  return "";
}
</script>
</body>
</html>
