<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel OTIF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <!-- SheetJS para Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .card{transition:transform .15s ease,box-shadow .15s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .chip{font-size:.75rem;padding:.5rem .75rem;border-radius:9999px;background:#f1f5f9;color:#475569}
    .modal-bg{background:rgba(0,0,0,.45)}
    .btn{padding:.5rem .75rem;border-radius:.5rem;font-weight:600}
    .tbl th,.tbl td{padding:.5rem .5rem;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    .cell-edit[contenteditable="true"]{background:#fffbe6;outline:none}
    .icon-btn{font-size:.9rem;padding:.35rem .6rem;border-radius:.375rem}
    .th-sticky{position:sticky; top:0; background:#f1f5f9; z-index:1}
    /* Alvos maiores no mobile */
    @media (max-width:640px){
      .icon-btn,.btn{padding:.6rem .8rem}
      .card{padding:1rem}
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- LOGIN -->
  <section id="login-screen" class="min-h-screen grid place-items-center">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-extrabold">Painel <span class="text-blue-600">OTIF</span></h1>
        <p class="text-sm text-slate-500 mt-1">Acesse com seu usu√°rio e senha</p>
      </div>
      <div class="space-y-3">
        <input id="user" class="w-full rounded-lg border p-3" placeholder="Usu√°rio"/>
        <input id="pass" type="password" class="w-full rounded-lg border p-3" placeholder="Senha"/>
        <button onclick="login()" class="w-full rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3">Entrar</button>
      </div>
      <!-- (Observa√ß√£o: texto de credenciais removido conforme solicitado) -->
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
      <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold tracking-tight">üìä Painel OTIF</h2>
          <p class="text-sm text-blue-100">#MegaOtif - Atualiza√ß√µes em tempo real</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="userName" class="text-sm bg-white/15 px-3 py-1 rounded-full"></span>
          <button onclick="logout()" class="text-sm font-semibold bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">Sair</button>
        </div>
      </div>
      <div id="metaBanner" class="hidden text-center py-2 font-semibold"></div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">
      <!-- Filtros -->
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex flex-wrap items-center gap-3">
          <span class="font-semibold">Per√≠odo:</span>
          <input id="startDate" type="date" class="border rounded-lg p-2">
          <input id="endDate" type="date" class="border rounded-lg p-2">
          <button onclick="filtrarDados()" class="rounded-lg bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 font-semibold">Aplicar</button>
          <div class="ml-auto flex gap-2">
            <button onclick="presetDia()"    class="chip">Hoje</button>
            <button onclick="presetSemana()" class="chip">Semana</button>
            <button onclick="presetMes()"    class="chip">M√™s</button>
          </div>
        </div>
      </div>

      <!-- Config Visibilidade (Master) -->
      <div id="visPanel" class="hidden bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Configura√ß√µes de Visibilidade (para perfil Visual)</h3>
          <button id="visSaveBtn" class="px-3 py-1 rounded bg-blue-600 text-white text-sm font-semibold">Salvar</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 text-sm">
          <label class="flex items-center gap-2"><input id="visPie"    type="checkbox" class="scale-110"> Motivos (Pizza)</label>
          <label class="flex items-center gap-2"><input id="visPareto" type="checkbox" class="scale-110"> Pareto (Setores)</label>
          <label class="flex items-center gap-2"><input id="visLinha"  type="checkbox" class="scale-110"> Evolu√ß√£o (Linha)</label>
          <label class="flex items-center gap-2"><input id="visTabela" type="checkbox" class="scale-110"> Tabela de Atrasos</label>
        </div>
        <p class="text-xs text-slate-500 mt-2">Essas op√ß√µes n√£o afetam o Master. O Visual ver√° apenas o que estiver habilitado.</p>
      </div>

      <!-- Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
        <div class="card bg-white rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-slate-500">Total de Pedidos</span><span class="text-slate-400">Œ£</span>
          </div>
          <div class="mt-2 text-2xl font-bold" id="totalPedidos">0</div>
        </div>

        <div id="cardPrazo" class="card bg-emerald-50 rounded-2xl shadow p-4 cursor-pointer" title="Duplo clique (desktop) ou toque longo (mobile)">
          <div class="flex justify-between">
            <span class="text-emerald-700">No Prazo</span><span>‚úÖ</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-emerald-800" id="entreguesPrazo">0</div>
          <p class="text-xs text-emerald-700/70 mt-1">Abrir planilha</p>
        </div>

        <div id="cardFora" class="card bg-rose-50 rounded-2xl shadow p-4 cursor-pointer" title="Duplo clique (desktop) ou toque longo (mobile)">
          <div class="flex justify-between">
            <span class="text-rose-700">Fora do Prazo</span><span>‚õî</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-rose-800" id="foraPrazo">0</div>
          <p class="text-xs text-rose-700/70 mt-1">Abrir planilha</p>
        </div>

        <div class="card bg-amber-50 rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-amber-700">N/C</span><span>‚ùî</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-amber-800" id="naoClassificados">0</div>
        </div>

        <div class="card bg-blue-50 rounded-2xl shadow p-4">
          <div class="flex justify-between">
            <span class="text-blue-700">OTIF (%)</span><span>üìà</span>
          </div>
          <div class="mt-2 text-2xl font-bold text-blue-800" id="otifPercent">0%</div>
        </div>

        <div class="card bg-slate-100 rounded-2xl shadow p-4">
          <div class="flex justify-between items-center">
            <span class="text-slate-700">Meta (%)</span>
            <button id="btnEditMeta" class="hidden text-xs bg-white px-2 py-1 rounded border">‚úèÔ∏è Editar</button>
          </div>
          <div class="mt-2 text-2xl font-bold flex items-center gap-3">
            <span id="metaPercent">80%</span>
            <input id="metaInput" type="number" min="0" max="100" step="0.01" class="hidden border rounded px-2 py-1 w-24"/>
            <button id="btnSaveMeta" class="hidden text-xs bg-emerald-600 text-white px-2 py-1 rounded">Salvar</button>
            <button id="btnCancelMeta" class="hidden text-xs bg-slate-300 text-slate-800 px-2 py-1 rounded">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- A√ß√µes do Master (opcional manter CSV global) -->
      <div id="blocoMaster" class="hidden bg-white rounded-2xl shadow p-4 flex flex-wrap items-center gap-3">
        <span class="font-semibold">Admin:</span>
        <input id="csvInput" type="file" accept=".csv" class="hidden"/>
        <button onclick="document.getElementById('csvInput').click()" class="btn bg-emerald-600 hover:bg-emerald-700 text-white">
          Importar CSV (Fora Prazo)
        </button>
        <button onclick="baixarTemplate()" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800">
          Baixar Template CSV
        </button>
        <span class="text-xs text-slate-500">CSV separado por v√≠rgula/; ‚Ä¢ Datas DD/MM/AAAA ou AAAA-MM-DD</span>
      </div>

      <!-- Gr√°ficos -->
      <div id="graficoGrid" class="grid gap-6 transition-all duration-300">
        <div id="sectionPie" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Motivos de Atraso</h3>
          <canvas id="graficoPizza"></canvas>
        </div>
        <div id="sectionPareto" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Pareto ‚Äì Setores</h3>
          <canvas id="graficoPareto"></canvas>
        </div>
        <div id="sectionLinha" class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-2">Evolu√ß√£o (atrasos por dia)</h3>
          <canvas id="graficoLinha"></canvas>
        </div>
      </div>

      <!-- Tabela de atrasos -->
      <div id="sectionTabela" class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Pedidos em Atraso</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 text-left">
              <tr>
                <th class="p-2">Cliente</th>
                <th class="p-2">Pedido</th>
                <th class="p-2">Produto</th>
                <th class="p-2">Motivo</th>
                <th class="p-2">Setor</th>
                <th class="p-2">DataEntrega</th>
              </tr>
            </thead>
            <tbody id="tabelaDados" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </main>
  </section>

  <!-- MODAL: planilha (No Prazo / Fora Prazo) -->
  <div id="modalList" class="hidden fixed inset-0 modal-bg z-40">
    <div class="min-h-full grid place-items-center px-4">
      <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 id="modalListTitle" class="text-xl font-semibold">Listagem</h2>
          <div class="flex flex-wrap items-center gap-2">
            <input id="excelInputModal" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
            <button id="btnImportModal" class="hidden icon-btn bg-amber-500 text-white">Importar XLSX/CSV</button>
            <button id="btnDeleteSel" class="hidden icon-btn bg-rose-500 text-white">Excluir selecionados</button>
            <button id="btnDeleteAll" class="hidden icon-btn bg-rose-700 text-white">Excluir TUDO</button>
            <button id="btnAddRow" class="hidden icon-btn bg-emerald-600 text-white">+ Linha</button>
            <button id="btnSaveSheet" class="hidden icon-btn bg-blue-600 text-white">Salvar</button>
            <button onclick="fecharModalList()" class="icon-btn bg-slate-200 text-slate-800">Fechar</button>
          </div>
        </div>
        <div class="overflow-x-auto max-h-[65vh]">
          <table class="w-full text-sm tbl">
            <thead id="modalHead" class="bg-slate-100 text-left th-sticky"></thead>
            <tbody id="modalBody" class="bg-white"></tbody>
          </table>
        </div>
        <p id="modalHint" class="text-xs text-slate-500 mt-3"></p>
      </div>
    </div>
  </div>

<script>
/* =============== Firebase Init =============== */
const firebaseConfig = {
  apiKey: "AIzaSyBbo6DNAzPFqUgfu_zDjw7f_711L3UfHfY",
  authDomain: "painel-otif.firebaseapp.com",
  projectId: "painel-otif",
  storageBucket: "painel-otif.firebasestorage.app",
  messagingSenderId: "1059621768811",
  appId: "1:1059621768811:web:b8c70235f3c17490bbab2e",
  measurementId: "G-2WF5J8CCM8",
  databaseURL: "https://painel-otif-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

/* =============== GLOBAL STATE/REFS =============== */
const REF_FORA   = db.ref("otif/foraPrazo");
const REF_PRAZO  = db.ref("otif/noPrazo");
const REF_META   = db.ref("otif/meta/globalPercent");
const REF_VIS    = db.ref("otif/config/visibilityForViewer");

let atrasos = [];
let noPrazo = [];
let metaValue = 80;
let visConfig = { pie:true, pareto:true, linha:true, tabela:true };
let chartPizza=null, chartPareto=null, chartLinha=null;
let usuarioAtual = { nome:'visual', role:'visual' }; // default
let modalTipo="fora";

/* =============== AUTH STATE =============== */
auth.onAuthStateChanged(async (user) => {
  if (user) {
    try{
      const snap = await firebase.database().ref(`otif/admins/${user.uid}`).get();
      const isAdmin = snap.val() === true;
      if (isAdmin) {
        usuarioAtual = { nome: user.email || 'master', role: 'master' };
        id('btnEditMeta').classList.remove('hidden');
        id('blocoMaster').classList.remove('hidden');
        id('visPanel').classList.remove('hidden');
        id('userName').textContent = `Usu√°rio: ${usuarioAtual.nome} (master)`;
      } else {
        usuarioAtual = { nome: user.email || 'visual', role: 'visual' };
        id('btnEditMeta').classList.add('hidden');
        id('blocoMaster').classList.add('hidden');
        id('visPanel').classList.add('hidden');
        id('userName').textContent = `Usu√°rio: ${usuarioAtual.nome} (visual)`;
      }
      id('login-screen').classList.add('hidden');
      id('dashboard').classList.remove('hidden');
    }catch(e){ console.error(e); }
  } else {
    usuarioAtual = { nome:'visual', role:'visual' };
    id('btnEditMeta').classList.add('hidden');
    id('blocoMaster').classList.add('hidden');
    id('visPanel').classList.add('hidden');
  }
  bindCardOpeners();          // dblclick + toque longo
  bindMetaButtons();          // edi√ß√£o de meta
  if (typeof renderizarTudo === 'function') renderizarTudo();
});

/* =============== LOGIN/LOGOUT =============== */
async function login(){
  const u = qs("#user").value.trim();
  const p = qs("#pass").value.trim();

  // MASTER: e-mail/senha via Firebase Auth (inalterado)
  if (u.includes("@")) {
    try {
      await auth.signInWithEmailAndPassword(u, p);
    } catch (e) {
      console.error(e); alert("Falha ao autenticar (master). Verifique e-mail/senha.");
    }
    return;
  }

  // VISUAL fixo (pedido): usuario / mega0tif
  if (u.toLowerCase()==="usuario" && p==="mega0tif") {
    try { await auth.signOut(); } catch {}
    usuarioAtual = { nome:'usuario', role:'visual' };
    id('login-screen').classList.add('hidden');
    id('dashboard').classList.remove('hidden');
    id('userName').textContent = `Usu√°rio: ${usuarioAtual.nome} (visual)`;
    bindCardOpeners();
    bindMetaButtons();
    renderizarTudo();
    return;
  }
  alert("Credenciais inv√°lidas.");
}
async function logout(){
  try { await auth.signOut(); } catch(e){ console.error(e); }
  usuarioAtual=null;
  id('dashboard').classList.add('hidden');
  id('login-screen').classList.remove('hidden');
}

/* =============== SUBSCRIBE DB =============== */
REF_FORA.on("value", s=>{ atrasos = s.val() || []; renderizarTudo(); });
REF_PRAZO.on("value", s=>{ noPrazo = s.val() || []; renderizarTudo(); });
REF_META.on("value", s=>{ const v=parseFloat(s.val()); if(!isNaN(v)) metaValue=v; renderizarTudo(); });
REF_VIS.on("value", s=>{
  const v=s.val(); if(v) visConfig={ pie:!!v.pie, pareto:!!v.pareto, linha:!!v.linha, tabela:!!v.tabela };
  if(usuarioAtual?.role==='master'){
    id("visPie").checked=visConfig.pie; id("visPareto").checked=visConfig.pareto;
    id("visLinha").checked=visConfig.linha; id("visTabela").checked=visConfig.tabela;
  }
  applyVisibilityForViewer(); ajustarGridGraficos();
});

/* =============== FILTERS/RENDER =============== */
function filtrarDados(){ renderizarTudo(); }
function presetDia(){ const d=isoToday(); setDates(d,d); renderizarTudo(); }
function presetSemana(){
  const now=new Date(), day=now.getDay()||7;
  const mon=new Date(now); mon.setDate(now.getDate()-day+1);
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  setDates(toISO(mon), toISO(sun)); renderizarTudo();
}
function presetMes(){
  const now=new Date(); const first=new Date(now.getFullYear(),now.getMonth(),1); const last=new Date(now.getFullYear(),now.getMonth()+1,0);
  setDates(toISO(first), toISO(last)); renderizarTudo();
}
function setDates(s,e){ id("startDate").value=s; id("endDate").value=e; }
function aplicaPeriodo(lista){
  const s=id("startDate").value, e=id("endDate").value;
  if(!s||!e) return [...lista];
  return lista.filter(r => (r.dataEntrega||"")>=s && (r.dataEntrega||"")<=e);
}

function renderizarTudo(){
  const atrasosF=aplicaPeriodo(atrasos), prazoF=aplicaPeriodo(noPrazo);
  const total=atrasosF.length+prazoF.length, fora=atrasosF.length, ok=prazoF.length, nc=0;
  const otif = total>0 ? ((ok/total)*100) : 0;

  txt("totalPedidos", total);
  txt("entreguesPrazo", ok);
  txt("foraPrazo", fora);
  txt("naoClassificados", nc);
  txt("otifPercent", `${otif.toFixed(2)}%`);
  txt("metaPercent", `${metaValue.toFixed(2)}%`);
  atualizarStatusMeta(otif, metaValue);

  const tbody=id("tabelaDados"); tbody.innerHTML="";
  atrasosF.forEach(a=>{
    tbody.insertAdjacentHTML("beforeend", `
      <tr class="hover:bg-slate-50">
        <td class="p-2">${a.cliente||""}</td>
        <td class="p-2">${a.pedido||""}</td>
        <td class="p-2">${a.produto||""}</td>
        <td class="p-2">${a.motivo||""}</td>
        <td class="p-2">${a.setor||""}</td>
        <td class="p-2">${a.dataEntrega||""}</td>
      </tr>
    `);
  });

  renderGraficos(atrasosF);
  applyVisibilityForViewer();
  ajustarGridGraficos();
}

/* =============== BANNER META (üëç/üëé) =============== */
function atualizarStatusMeta(otif, meta){
  const banner = id("metaBanner");
  const bateu = otif >= meta;
  const emoji = bateu ? "üëç" : "üëé";
  banner.textContent = `${emoji} OTIF ${otif.toFixed(2)}% ‚Äî Meta ${meta.toFixed(2)}%`;
  banner.classList.remove("hidden");
  banner.className = "text-center py-2 font-semibold " + (bateu ? "bg-emerald-50 text-emerald-700" : "bg-rose-50 text-rose-700");
}

/* =============== EDI√á√ÉO DE META (MASTER) =============== */
function bindMetaButtons(){
  const edit = id("btnEditMeta"), save=id("btnSaveMeta"), cancel=id("btnCancelMeta");
  if(!edit || !save || !cancel) return;

  edit.onclick = ()=>{
    if(usuarioAtual?.role!=="master") return;
    id("metaInput").value = metaValue.toFixed(2);
    id("metaPercent").classList.add("hidden");
    id("metaInput").classList.remove("hidden");
    save.classList.remove("hidden");
    cancel.classList.remove("hidden");
    edit.classList.add("hidden");
  };
  cancel.onclick = ()=>{
    id("metaPercent").classList.remove("hidden");
    id("metaInput").classList.add("hidden");
    save.classList.add("hidden");
    cancel.classList.add("hidden");
    if(usuarioAtual?.role==="master") id("btnEditMeta").classList.remove("hidden");
  };
  save.onclick = async ()=>{
    if(usuarioAtual?.role!=="master") return;
    const v = parseFloat(id("metaInput").value);
    if(isNaN(v) || v<0 || v>100){ alert("Informe uma meta entre 0 e 100."); return; }
    metaValue = v;
    await REF_META.set(v);
    id("metaPercent").textContent = `${v.toFixed(2)}%`;
    cancel.onclick(); // volta para o modo de visualiza√ß√£o
  };
}

/* =============== CHARTS =============== */
function renderGraficos(data){
  if(chartPizza) chartPizza.destroy();
  if(chartPareto) chartPareto.destroy();
  if(chartLinha) chartLinha.destroy();

  const motivos=countBy(data, d=> (d.motivo||"Sem motivo"));
  chartPizza=new Chart(id("graficoPizza"),{type:"pie",data:{labels:Object.keys(motivos),datasets:[{data:Object.values(motivos)}]}});

  const setoresMap=countBy(data, d=> (d.setor||"Sem setor"));
  const setoresOrd=Object.entries(setoresMap).sort((a,b)=>b[1]-a[1]);
  chartPareto=new Chart(id("graficoPareto"),{
    type:"bar",
    data:{labels:setoresOrd.map(x=>x[0]),datasets:[{label:"Atrasos",data:setoresOrd.map(x=>x[1])}]},
    options:{plugins:{legend:{display:false}}}
  });

  const porData=countBy(data, d=> d.dataEntrega||"");
  const datasOrd=Object.keys(porData).sort();
  chartLinha=new Chart(id("graficoLinha"),{
    type:"line",
    data:{labels:datasOrd,datasets:[{label:"Atrasos",data:datasOrd.map(k=>porData[k])}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}
function countBy(arr, fn){ const m={}; arr.forEach(x=>{const k=fn(x); m[k]=(m[k]||0)+1;}); return m; }

/* =============== GRID AJUSTE =============== */
function ajustarGridGraficos(){
  const grid = id("graficoGrid");
  const visiveis = ["#sectionPie","#sectionPareto","#sectionLinha"]
    .map(sel => document.querySelector(sel))
    .filter(el => el && el.style.display !== "none");
  const count = visiveis.length;
  let colsClass = "grid-cols-1 md:grid-cols-3";
  if (count === 1) colsClass = "grid-cols-1";
  if (count === 2) colsClass = "grid-cols-1 md:grid-cols-2";
  if (count === 3) colsClass = "grid-cols-1 md:grid-cols-3";
  grid.className = `grid gap-6 transition-all duration-300 ${colsClass}`;
  visiveis.forEach(v => v.classList.add("h-full"));
}

/* =============== CARDS: dblclick + toque longo (MOBILE) =============== */
function bindCardOpeners(){
  const cPrazo = id("cardPrazo");
  const cFora  = id("cardFora");
  if(cPrazo){
    cPrazo.addEventListener("dblclick", ()=> abrirPlanilha("prazo"), {once:false});
    enableLongPress(cPrazo, ()=> abrirPlanilha("prazo"), 600);
  }
  if(cFora){
    cFora.addEventListener("dblclick", ()=> abrirPlanilha("fora"),  {once:false});
    enableLongPress(cFora, ()=> abrirPlanilha("fora"), 600);
  }
}

/* =============== MODAL PLANILHA =============== */
function abrirPlanilha(tipo){
  modalTipo=tipo;
  const isMaster = usuarioAtual?.role==="master";
  txt("modalListTitle", tipo==="fora" ? "Fora do Prazo" : "No Prazo");

  // Bot√µes vis√≠veis s√≥ para master
  toggle("#btnAddRow", isMaster);
  toggle("#btnSaveSheet", isMaster);
  toggle("#btnImportModal", isMaster);
  toggle("#btnDeleteSel", isMaster);
  toggle("#btnDeleteAll", isMaster);

  // Cabe√ßalho com checkbox geral
  const head = (tipo==="fora")
    ? ["", "Cliente","Pedido","Produto","Quantidade","Motivo/Obs","Setor","DataCliente","DataEntrega","A√ß√µes"]
    : ["", "Cliente","Pedido","Produto","Quantidade","DataCliente","DataEntrega","A√ß√µes"];
  const selectAll = `<input id="chkAll" type="checkbox" onchange="toggleSelectAll(this)">`;
  id("modalHead").innerHTML = `<tr>${
    head.map((h,i)=>`<th class="p-2 ${i===0?'w-8':''}">${i===0?selectAll:h}</th>`).join("")
  }</tr>`;

  // Corpo
  const data = (tipo==="fora") ? aplicaPeriodo(atrasos) : aplicaPeriodo(noPrazo);
  const editable = isMaster;
  const body=id("modalBody"); body.innerHTML="";
  data.forEach((r, idx)=> body.insertAdjacentHTML("beforeend", linhaModalHTML(r, idx, tipo, editable)));

  txt("modalHint", isMaster
    ? "Cole colunas inteiras do Excel/Sheets: selecione a c√©lula inicial e cole. Linhas s√£o criadas automaticamente. Depois clique em Salvar."
    : "Visualiza√ß√£o somente leitura.");

  // Eventos dos bot√µes do modal
  id("btnAddRow").onclick = addLinha;
  id("btnSaveSheet").onclick = salvarPlanilha;
  id("btnImportModal").onclick = ()=> id("excelInputModal").click();
  id("btnDeleteAll").onclick = excluirTudo;
  id("btnDeleteSel").onclick = excluirSelecionados;
  id("excelInputModal").onchange = importarExcelModal;

  // Colagem por COLUNA (v√°rias linhas) ‚Äì captura mesmo dentro de c√©lula
  body.onpaste = handlePasteColumn;
  body.addEventListener("paste", handlePasteColumn, true);

  id("modalList").classList.remove("hidden");
}

function linhaModalHTML(r, idxView, tipo, editable){
  const ce=(v,f)=>`<td class="cell-edit" contenteditable="${editable}" data-field="${f}">${v??""}</td>`;
  const delBtn = (usuarioAtual?.role==="master")
    ? `<button class="icon-btn bg-rose-100 text-rose-700" onclick="excluirLinha(${idxView})">Excluir</button>` : "";
  const chk = `<input type="checkbox" class="rowchk" data-idx="${idxView}">`;

  if(tipo==="fora"){
    return `<tr>
      <td class="p-2">${chk}</td>
      ${ce(r.cliente,"cliente")}
      ${ce(r.pedido,"pedido")}
      ${ce(r.produto,"produto")}
      ${ce(r.quantidade,"quantidade")}
      ${ce(r.motivo,"motivo")}
      ${ce(r.setor,"setor")}
      ${ce(r.dataCliente,"dataCliente")}
      ${ce(r.dataEntrega,"dataEntrega")}
      <td class="p-2">${delBtn}</td>
    </tr>`;
  } else {
    return `<tr>
      <td class="p-2">${chk}</td>
      ${ce(r.cliente,"cliente")}
      ${ce(r.pedido,"pedido")}
      ${ce(r.produto,"produto")}
      ${ce(r.quantidade,"quantidade")}
      ${ce(r.dataCliente,"dataCliente")}
      ${ce(r.dataEntrega,"dataEntrega")}
      <td class="p-2">${delBtn}</td>
    </tr>`;
  }
}
function fecharModalList(){ id("modalList").classList.add("hidden"); }

/* A√ß√µes do modal */
async function addLinha(){
  if(usuarioAtual?.role!=="master") return;
  const novo = (modalTipo==="fora")
    ? {cliente:"",pedido:"",produto:"",quantidade:"",motivo:"",setor:"",dataCliente:"",dataEntrega:""}
    : {cliente:"",pedido:"",produto:"",quantidade:"",dataCliente:"",dataEntrega:""};
  if(modalTipo==="fora"){ atrasos.push(novo); await REF_FORA.set(atrasos); }
  else { noPrazo.push(novo); await REF_PRAZO.set(noPrazo); }
  abrirPlanilha(modalTipo);
}

async function salvarPlanilha(){
  if(usuarioAtual?.role!=="master") return;
  const rows=[...document.querySelectorAll("#modalBody tr")];
  const dados = rows.map(tr=>{
    const obj={};
    tr.querySelectorAll("td[data-field]").forEach(td=>{
      const k=td.getAttribute("data-field"); let v=td.textContent.trim();
      if(k==="dataCliente"||k==="dataEntrega") v=normalizeDateToISO(v);
      obj[k]=v;
    });
    return obj;
  }).filter(o=> (o.cliente||"") && (o.pedido||"") && (o.dataEntrega||""));

  if(modalTipo==="fora"){ atrasos=dados; await REF_FORA.set(atrasos); }
  else { noPrazo=dados; await REF_PRAZO.set(noPrazo); }

  alert("Planilha salva com sucesso.");
  renderizarTudo();
  abrirPlanilha(modalTipo);
}

async function excluirLinha(idxView){
  if(usuarioAtual?.role!=="master") return;
  const baseF = (modalTipo==="fora") ? aplicaPeriodo(atrasos) : aplicaPeriodo(noPrazo);
  const alvo = baseF[idxView]; if(!alvo) return;
  const base = (modalTipo==="fora") ? atrasos : noPrazo;
  const i = base.findIndex(x=> JSON.stringify(x)===JSON.stringify(alvo));
  if(i>=0) base.splice(i,1);
  if(modalTipo==="fora") await REF_FORA.set(atrasos); else await REF_PRAZO.set(noPrazo);
  abrirPlanilha(modalTipo); renderizarTudo();
}

async function excluirTudo(){
  if(usuarioAtual?.role!=="master") return;
  if(!confirm("Tem certeza que deseja excluir TODOS os registros desta planilha?")) return;
  if(modalTipo==="fora"){ atrasos=[]; await REF_FORA.set([]); }
  else { noPrazo=[]; await REF_PRAZO.set([]); }
  abrirPlanilha(modalTipo); renderizarTudo();
}

async function excluirSelecionados(){
  if(usuarioAtual?.role!=="master") return;
  const chks=[...document.querySelectorAll(".rowchk:checked")];
  if(chks.length===0){ alert("Selecione ao menos uma linha."); return; }
  const base = (modalTipo==="fora") ? atrasos : noPrazo;
  const baseF = (modalTipo==="fora") ? aplicaPeriodo(atrasos) : aplicaPeriodo(noPrazo);

  chks.forEach(chk=>{
    const idxView=parseInt(chk.getAttribute("data-idx"));
    const alvo = baseF[idxView];
    const i = base.findIndex(x=> JSON.stringify(x)===JSON.stringify(alvo));
    if(i>=0) base.splice(i,1);
  });
  if(modalTipo==="fora") await REF_FORA.set(atrasos); else await REF_PRAZO.set(noPrazo);
  abrirPlanilha(modalTipo); renderizarTudo();
}

function toggleSelectAll(master){
  document.querySelectorAll(".rowchk").forEach(c=> c.checked = master.checked);
}

/* =============== COLAR V√ÅRIAS LINHAS EM UMA COLUNA =============== */
function handlePasteColumn(e){
  if(usuarioAtual?.role!=="master") return;

  const td = e.target.closest('td[data-field]');
  if(!td) return; // s√≥ tratamos colagem em c√©lulas edit√°veis

  const text = (e.clipboardData || window.clipboardData)?.getData("text");
  if(!text) return;

  e.preventDefault();

  // Se vier TSV/CSV, usamos apenas a PRIMEIRA coluna. Cada linha vira uma c√©lula abaixo.
  const lines = text
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l.length>0)
    .map(l => {
      if(l.includes("\t")) return l.split("\t")[0].trim();
      if(l.includes(","))  return l.split(",")[0].trim();
      if(l.includes(";"))  return l.split(";")[0].trim();
      return l;
    });

  if(lines.length===0) return;

  const tbody = document.getElementById("modalBody");
  const rows = [...tbody.querySelectorAll("tr")];

  const startRow = rows.indexOf(td.parentElement);
  if(startRow < 0) return;

  // cria linhas em branco se necess√°rio (apenas no DOM ‚Äì salvar √© manual)
  const need = startRow + lines.length - rows.length;
  if(need > 0){
    for(let i=0;i<need;i++){
      const objVazio = (modalTipo==="fora")
        ? {cliente:"",pedido:"",produto:"",quantidade:"",motivo:"",setor:"",dataCliente:"",dataEntrega:""}
        : {cliente:"",pedido:"",produto:"",quantidade:"",dataCliente:"",dataEntrega:""};
      const idxView = rows.length + i;
      const html = linhaModalHTML(objVazio, idxView, modalTipo, true);
      tbody.insertAdjacentHTML("beforeend", html);
    }
  }

  const field = td.getAttribute("data-field");
  const finalRows = [...tbody.querySelectorAll("tr")];

  for(let i=0;i<lines.length;i++){
    const tr = finalRows[startRow + i];
    if(!tr) break;
    const cell = tr.querySelector(`td[data-field="${field}"]`);
    if(cell){
      cell.textContent = lines[i];
    }
  }

  const hint = document.getElementById("modalHint");
  if(hint){
    hint.textContent = "Colagem conclu√≠da nesta coluna. Revise e clique em Salvar para gravar no banco.";
  }
}

/* =============== IMPORTAR NO MODAL (XLSX/CSV) =============== */
async function importarExcelModal(ev){
  if(usuarioAtual?.role!=="master") return;
  const file = ev.target.files?.[0]; if(!file) return;
  try{
    const ext = (file.name.split(".").pop()||"").toLowerCase();
    let linhas = [];
    if(ext==="xlsx" || ext==="xls"){
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data);
      const ws = wb.Sheets[wb.SheetNames[0]];
      linhas = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});
    } else if(ext==="csv"){
      const text = await file.text();
      linhas = parseCSV(text);
    } else {
      alert("Formato n√£o suportado. Use .xlsx, .xls ou .csv");
      ev.target.value=""; return;
    }
    if(!linhas || !linhas.length){ alert("Arquivo vazio."); ev.target.value=""; return; }

    const header = linhas[0].map(normalizeHeader);
    const idxCommon = {
      cliente: header.indexOf("cliente"),
      pedido: header.indexOf("pedido"),
      produto: header.indexOf("produto"),
      quantidade: header.indexOf("quantidade"),
      datacliente: header.indexOf("datacliente"),
      dataentrega: header.indexOf("dataentrega")
    };
    const idxExtras = {
      motivo: (()=>{const i1=header.indexOf("motivo"), i2=header.indexOf("motivoobs"); return i1>=0?i1:(i2>=0?i2:-1);})(),
      setor: header.indexOf("setor")
    };

    const faltantesPrazo = [idxCommon.cliente,idxCommon.pedido,idxCommon.produto,idxCommon.quantidade,idxCommon.datacliente,idxCommon.dataentrega].some(v=>v===-1);
    const faltantesFora  = [idxCommon.cliente,idxCommon.pedido,idxCommon.produto,idxCommon.quantidade,idxExtras.setor,idxCommon.dataentrega].some(v=>v===-1);

    if( (modalTipo==="prazo" && faltantesPrazo) || (modalTipo==="fora" && faltantesFora) ){
      alert("Cabe√ßalho esperado:\n\nNo Prazo: cliente, pedido, produto, quantidade, datacliente, dataentrega\nFora Prazo: cliente, pedido, produto, quantidade, motivo/obs, setor, datacliente, dataentrega");
      ev.target.value=""; return;
    }

    const novos=[];
    for(let i=1;i<linhas.length;i++){
      const r=linhas[i]; if(!r || !r.length) continue;
      const base = {
        cliente: (r[idxCommon.cliente]??"").toString().trim(),
        pedido:  (r[idxCommon.pedido]??"").toString().trim(),
        produto: (r[idxCommon.produto]??"").toString().trim(),
        quantidade: (r[idxCommon.quantidade]??"").toString().trim(),
        dataCliente: normalizeDateToISO((r[idxCommon.datacliente]??"").toString().trim()),
        dataEntrega: normalizeDateToISO((r[idxCommon.dataentrega]??"").toString().trim())
      };
      if(modalTipo==="fora"){
        base.motivo = (idxExtras.motivo>=0 ? (r[idxExtras.motivo]??"") : "").toString().trim();
        base.setor  = (r[idxExtras.setor]??"").toString().trim();
        if(!base.cliente || !base.pedido || !base.dataEntrega) continue;
      } else {
        if(!base.cliente || !base.pedido || !base.dataEntrega) continue;
      }
      novos.push(base);
    }

    if(modalTipo==="fora"){ atrasos = atrasos.concat(novos); await REF_FORA.set(atrasos); }
    else { noPrazo = noPrazo.concat(novos); await REF_PRAZO.set(noPrazo); }

    ev.target.value="";
    alert(`Importa√ß√£o conclu√≠da: ${novos.length} linha(s) adicionada(s).`);
    abrirPlanilha(modalTipo); renderizarTudo();
  }catch(e){
    console.error(e); alert("Falha ao importar arquivo.");
    ev.target.value="";
  }
}

/* =============== VISIBILIDADE (viewer) =============== */
function applyVisibilityForViewer(){
  if(usuarioAtual?.role!=="visual"){
    show("#sectionPie", true); show("#sectionPareto", true); show("#sectionLinha", true); show("#sectionTabela", true);
    return;
  }
  const vis=visConfig;
  show("#sectionPie", !!vis.pie);
  show("#sectionPareto", !!vis.pareto);
  show("#sectionLinha", !!vis.linha);
  show("#sectionTabela", !!vis.tabela);

  if(!vis.pie && chartPizza){ chartPizza.destroy(); chartPizza=null; }
  if(!vis.pareto && chartPareto){ chartPareto.destroy(); chartPareto=null; }
  if(!vis.linha && chartLinha){ chartLinha.destroy(); chartLinha=null; }
}
id("visSaveBtn").addEventListener("click", async ()=>{
  if(usuarioAtual?.role!=="master") return;
  const v={ pie:id("visPie").checked, pareto:id("visPareto").checked, linha:id("visLinha").checked, tabela:id("visTabela").checked };
  await REF_VIS.set(v);
  alert("Prefer√™ncias salvas (aplicam ao perfil Visual).");
  ajustarGridGraficos();
});

/* =============== CSV (fora prazo) legado =============== */
id("csvInput").addEventListener("change", async ev=>{
  if(usuarioAtual?.role!=="master"){ ev.target.value=""; return; }
  const file=ev.target.files?.[0]; if(!file) return;
  try{
    const text=await file.text(); const rows=parseCSV(text);
    if(rows.length<2){ alert("CSV sem dados."); return; }
    const header=rows[0].map(normalizeHeader);
    const idx={
      cliente:header.indexOf("cliente"),
      pedido:header.indexOf("pedido"),
      produto:header.indexOf("produto"),
      quantidade:header.indexOf("quantidade"),
      motivo:(()=>{const i1=header.indexOf("motivo"), i2=header.indexOf("motivoobs"); return i1>=0?i1:(i2>=0?i2:-1);})(),
      setor:header.indexOf("setor"),
      datacliente:header.indexOf("datacliente"),
      dataentrega:header.indexOf("dataentrega")
    };
    if([idx.cliente,idx.pedido,idx.produto,idx.quantidade,idx.setor,idx.dataentrega].some(v=>v===-1)){
      alert("Cabe√ßalho esperado: cliente,pedido,produto,quantidade,motivo/obs,setor,datacliente,dataentrega");
      return;
    }
    const novos=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r||!r.length) continue;
      const obj={
        cliente:(r[idx.cliente]??"").trim(),
        pedido:(r[idx.pedido]??"").trim(),
        produto:(r[idx.produto]??"").trim(),
        quantidade:(r[idx.quantidade]??"").trim(),
        motivo: idx.motivo>=0 ? (r[idx.motivo]??"").trim() : "",
        setor:(r[idx.setor]??"").trim(),
        dataCliente: normalizeDateToISO((r[idx.datacliente]??"").trim()),
        dataEntrega: normalizeDateToISO((r[idx.dataentrega]??"").trim())
      };
      if(!obj.cliente||!obj.pedido||!obj.dataEntrega) continue;
      novos.push(obj);
    }
    atrasos = atrasos.concat(novos); await REF_FORA.set(atrasos);
    ev.target.value="";
    alert(`Importa√ß√£o conclu√≠da: ${novos.length} inseridos.`);
    renderizarTudo();
  }catch(e){ console.error(e); alert("Falha ao ler o CSV."); ev.target.value=""; }
});
function baixarTemplate(){
  const content="cliente,pedido,produto,quantidade,motivo,setor,datacliente,dataentrega\nZION SIGNAL,10311/1,81100010,10,Mat√©ria-prima solicitada diferente,MegaWhip,2025-09-29,2025-10-01\n";
  const blob=new Blob([content],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="otif_foraprazo_template.csv"; a.click(); URL.revokeObjectURL(url);
}

/* =============== HELPERS =============== */
function qs(s){return document.querySelector(s)}
function id(s){return document.getElementById(s)}
function txt(el,val){ id(el).textContent=val }
function show(sel,flag){ const el=qs(sel); if(el) el.style.display = flag ? "" : "none"; }
function toggle(sel,flag){ const el=qs(sel); if(!el) return; el.classList.toggle("hidden", !flag); }
function isoToday(){ return new Date().toISOString().slice(0,10); }
function toISO(d){ const z=new Date(d); return z.toISOString().slice(0,10); }
function normalizeDateToISO(v){
  v=(v||"").trim();
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){ const [d,m,a]=v.split("/"); return `${a}-${m}-${d}`; }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const dt=new Date(v); if(!isNaN(dt.getTime())) return dt.toISOString().slice(0,10);
  return "";
}
function parseCSV(text){
  const hasSemicolon=text.indexOf(";")!==-1; const delim=hasSemicolon?";":",";
  const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
  return lines.map(line=>splitCSVLine(line,delim));
}
function splitCSVLine(line,delim){
  const out=[]; let cur="",q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){cur+='"';i++;} else q=!q; }
    else if(ch===delim && !q){ out.push(cur.trim()); cur=""; }
    else cur+=ch;
  }
  out.push(cur.trim()); return out;
}
function normalizeHeader(h){
  return (h||"").toString().trim().toLowerCase()
    .replace(/\s+/g,"").replace(/√ß/g,"c")
    .replace(/[√°√†√¢√£]/g,"a").replace(/[√©√®√™]/g,"e").replace(/[√≠√¨√Æ]/g,"i")
    .replace(/[√≥√≤√¥√µ]/g,"o").replace(/[√∫√π√ª]/g,"u").replace(/\//g,"");
}

/* Toque longo (mobile) */
function enableLongPress(el, cb, ms=600){
  let t=null, moved=false;
  el.addEventListener('touchstart', ()=>{ moved=false; t=setTimeout(()=>{ if(!moved){ cb(); } }, ms); }, {passive:true});
  el.addEventListener('touchmove',  ()=>{ moved=true; if(t){ clearTimeout(t); } }, {passive:true});
  el.addEventListener('touchend',   ()=>{ if(t){ clearTimeout(t); } }, {passive:true});
}
</script>
</body>
</html>

